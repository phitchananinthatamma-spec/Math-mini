<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Mini Game หลักการนับ Multiplayer</title>
<style>
body {
  background-color: black;
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}
h1 { font-weight: bold; margin-bottom: 10px; }
.question { font-size: 24px; font-weight: bold; margin: 20px 0; }
.answers { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; }
.answer-btn { background-color: #222; color: #fff; font-weight: bold;
  padding: 10px 20px; border: 2px solid #fff; cursor: pointer; width: 250px; }
.answer-btn:hover { background-color: #444; }
.players { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
.player { border: 2px solid #fff; padding: 10px; width: 150px; }
.timer { font-size: 20px; font-weight: bold; margin: 10px 0; }
#roomControls { margin: 20px; }
input, select, button { padding: 5px; margin: 5px; }
</style>
</head>
<body>

<h1>Mini Game หลักการนับ Multiplayer</h1>

<div id="roomControls">
  <input id="playerName" placeholder="ชื่อผู้เล่น">
  <select id="maxPlayers">
    <option value="2">2 คน</option>
    <option value="3">3 คน</option>
    <option value="4">4 คน</option>
    <option value="5">5 คน</option>
  </select>
  <button onclick="createRoom()">สร้างห้อง</button><br>
  <input id="roomIdInput" placeholder="รหัสห้อง">
  <button onclick="joinRoom()">เข้าห้อง</button>
</div>

<div id="roomInfo" style="margin:10px;font-weight:bold;"></div>

<div class="question" id="question">รอเริ่มเกม...</div>

<div class="answers" id="answers"></div>

<div class="timer" id="timer">เวลา: 30 วินาที</div>

<div class="players" id="players"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, push } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

// ---------- Firebase Config ----------
const firebaseConfig = {
  apiKey: "AIzaSyAScwLSlNF1i0cAAT-xadJTFOgGUEsIilk",
  authDomain: "count-raid-game.firebaseapp.com",
  databaseURL: "https://count-raid-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "count-raid-game",
  storageBucket: "count-raid-game.appspot.com",
  messagingSenderId: "887793946867",
  appId: "1:887793946867:web:14c0c60399fcefc8612786"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---------- ตัวแปรเกม ----------
let roomId = "";
let playerName = "";
let timeLeft = 30;
let timerInterval;
let currentQuestionIndex = 0;

// ---------- ตัวอย่างคำถามหลักการนับ ----------
const questions = [
  {q:"มีวิธีจัดเรียงตัวอักษร 3 ตัว A,B,C กี่วิธี?", a:["3","6","9","12"], correct:1, bonus:5},
  {q:"ถ้าโยนเหรียญ 2 เหรียญ จะมีผลลัพธ์กี่แบบ?", a:["2","3","4","5"], correct:2, bonus:3},
  {q:"เลือกตัวเลข 2 ตัวจาก 1,2,3,4 จะได้ชุดต่าง ๆ กี่ชุด?", a:["4","6","8","12"], correct:1, bonus:4},
];

// ---------- สร้างห้อง ----------
function createRoom(){
  playerName = document.getElementById('playerName').value.trim();
  if(!playerName){ alert("กรุณากรอกชื่อผู้เล่น!"); return; }
  const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
  if(!maxPlayers){ alert("กรุณาเลือกจำนวนผู้เล่น!"); return; }
  
  const roomRef = push(ref(db,'rooms'));
  roomId = roomRef.key;
  set(roomRef,{
    host:playerName,
    maxPlayers:maxPlayers,
    status:"waiting",
    questionIndex:0,
    players:{ [playerName]: {score:0} }
  }).then(()=>{
    document.getElementById('roomInfo').innerText=`สร้างห้องสำเร็จ! รหัสห้อง: ${roomId} ให้เพื่อนเข้าห้อง`;
    listenRoom();
  }).catch(err=>{
    alert("เกิดข้อผิดพลาด: "+err.message);
  });
}

// ---------- เข้าห้อง ----------
function joinRoom(){
  playerName = document.getElementById('playerName').value.trim();
  if(!playerName){ alert("กรุณากรอกชื่อผู้เล่น!"); return; }
  roomId = document.getElementById('roomIdInput').value.trim();
  if(!roomId){ alert("กรุณากรอกรหัสห้อง!"); return; }
  
  const playerRef = ref(db, `rooms/${roomId}/players/${playerName}`);
  set(playerRef, {score:0}).then(()=>{
    document.getElementById('roomInfo').innerText=`เข้าห้องสำเร็จ! รหัสห้อง: ${roomId}`;
    listenRoom();
  }).catch(err=>{
    alert("เกิดข้อผิดพลาด: "+err.message);
  });
}

// ---------- ฟังห้อง ----------
function listenRoom(){
  const roomRef = ref(db, `rooms/${roomId}`);
  onValue(roomRef, snapshot=>{
    const roomData = snapshot.val();
    if(!roomData) return;
    updatePlayers(roomData.players);
    currentQuestionIndex = roomData.questionIndex || 0;

    // เริ่มเกมเมื่อครบจำนวนผู้เล่น
    if(roomData.status==="waiting" && Object.keys(roomData.players).length === roomData.maxPlayers){
      set(ref(db, `rooms/${roomId}/status`),"playing");
    }

    if(roomData.status==="playing"){
      showQuestion();
    }
  });
}

// ---------- แสดงผู้เล่น ----------
function updatePlayers(playersObj){
  const playersDiv = document.getElementById('players');
  playersDiv.innerHTML="";
  for(const name in playersObj){
    const div = document.createElement('div');
    div.className="player";
    div.innerHTML=`<strong>${name}</strong><br>คะแนน: ${playersObj[name].score}`;
    playersDiv.appendChild(div);
  }
}

// ---------- แสดงคำถาม ----------
function showQuestion(){
  if(currentQuestionIndex>=questions.length) return;
  clearInterval(timerInterval);
  timeLeft = 30;

  const q = questions[currentQuestionIndex];
  document.getElementById('question').innerText = q.q;
  const answersDiv = document.getElementById('answers');
  answersDiv.innerHTML="";
  q.a.forEach((ans,index)=>{
    const btn=document.createElement('button');
    btn.className="answer-btn";
    btn.innerText = ans;
    btn.onclick = ()=> selectAnswer(index);
    answersDiv.appendChild(btn);
  });

  timerInterval=setInterval(()=>{
    timeLeft--;
    document.getElementById('timer').innerText=`เวลา: ${timeLeft} วินาที`;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      alert(`หมดเวลา! เฉลยคือ: ${q.a[q.correct]}`);
      nextQuestion();
    }
  },1000);
}

// ---------- เลือกคำตอบ ----------
function selectAnswer(index){
  const q=questions[currentQuestionIndex];
  const playerRef = ref(db, `rooms/${roomId}/players/${playerName}/score`);
  get(playerRef).then(snap=>{
    let score = snap.val()||0;
    if(index===q.correct){
      score += 10+q.bonus;
      alert(`ถูกต้อง! ได้คะแนนพิเศษ ${q.bonus}`);
    } else {
      score -=5;
      alert("ผิด! คะแนน -5");
    }
    set(playerRef,score);

    // แย่งคะแนนเพื่อน
    const playersRef = ref(db, `rooms/${roomId}/players`);
    get(playersRef).then(psnap=>{
      const playersData = psnap.val();
      const others = Object.keys(playersData).filter(p=>p!==playerName);
      if(others.length>0){
        const steal = others[Math.floor(Math.random()*others.length)];
        const stealRef = ref(db, `rooms/${roomId}/players/${steal}/score`);
        get(stealRef).then(ssnap=>{
          let sScore = ssnap.val()||0;
          sScore = Math.max(0, sScore-3);
          set(stealRef,sScore);
          set(playerRef,score+3);
          alert(`คุณแย่งคะแนนเพื่อน ${steal} ได้ 3 คะแนน`);
          nextQuestion();
        });
      } else { nextQuestion(); }
    });
  });
}

// ---------- ต่อคำถาม ----------
function nextQuestion(){
  currentQuestionIndex++;
  set(ref(db, `rooms/${roomId}/questionIndex`),currentQuestionIndex);
  if(currentQuestionIndex>=questions.length){
    alert("จบเกม!");
  } else { showQuestion(); }
}
</script>

</body>
</html>
